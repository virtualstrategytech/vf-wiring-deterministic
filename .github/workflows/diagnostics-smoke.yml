name: diagnostics-smoke (manual + on deployed smoke failure)

on:
  workflow_dispatch:
    inputs:
      WEBHOOK_BASE:
        description: 'Base URL to run smoke tests against (e.g. https://api.example)'
        required: false
        type: string
      SKIP_SMOKE:
        description: 'Set to true to skip smoke test execution'
        required: false
        type: boolean
  # Also run automatically when the Deployed smoke (manual) workflow completes
  # This lets diagnostics run automatically when the smoke workflow fails.
  workflow_run:
    workflows: ['Deployed smoke (manual)']
    types: [completed]

jobs:
  diagnostics:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') }}
    env:
      WEBHOOK_BASE: ${{ github.event.inputs.WEBHOOK_BASE || secrets.WEBHOOK_BASE }}
      WEBHOOK_API_KEY: ${{ secrets.WEBHOOK_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print environment
        run: |
          echo "Runner: $(uname -a)"
          node -v
          npm -v

      - name: Install deps
        run: |
          npm ci

      - name: Run network diagnostics (non-secret-safe)
        if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.WEBHOOK_BASE != '') || (github.event_name == 'workflow_run' && env.WEBHOOK_BASE != '') }}
        run: |
          MASKED="${{ github.event.inputs.WEBHOOK_BASE || env.WEBHOOK_BASE }}"
          echo "Masked base: $MASKED" | sed -E 's#(https?://)([^/]+).*#\1\2#g'
          echo '--- nslookup ---'
          nslookup "$MASKED" || true
          echo '--- curl -Iv ---'
          curl -Iv --max-time 15 "$MASKED" || true
          echo '--- traceroute ---'
          traceroute -m 8 "$MASKED" || true

      - name: Run smoke test (jest)
        env:
          WEBHOOK_BASE: ${{ github.event.inputs.WEBHOOK_BASE || env.WEBHOOK_BASE }}
          WEBHOOK_API_KEY: ${{ secrets.WEBHOOK_API_KEY }}
          DEBUG_TESTS: 'true'
        run: |
          # Run only the smoke test to keep runs fast and focused
          # Capture output for artifacts
          npx jest tests/webhook.smoke.test.js --runInBand --verbose 2>&1 | tee diagnostics_jest_output.txt || true

      - name: Upload logs/artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics-logs
          path: |
            ./npm-debug.log
            ./diagnostics_jest_output.txt
            ./tests/globalSetup.log
            ./npm-debug.log || true
